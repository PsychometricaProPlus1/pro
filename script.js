document.addEventListener("DOMContentLoaded",()=>{console.log("SCRIPT START: DOMContentLoaded event fired.");let e="psychometric_results",t="student_info",n="",i="",s={},r=[],a=[],o=0,l={},c=0,d=[{id:"student-name",labelEn:"Student's Name",labelMr:"विद्यार्थ्याचे नाव",type:"text"},{id:"parent-name",labelEn:"Parent's Name",labelMr:"पालकांचे नाव",type:"text"},{id:"mobile",labelEn:"Mobile (Parent/Guardian)",labelMr:"मोबाइल (पालक)",type:"tel",pattern:"\\d{10}"},{id:"email",labelEn:"Email (Parent/Guardian)",labelMr:"ईमेल (पालक)",type:"email"},{id:"age",labelEn:"Age",labelMr:"वय",type:"number",min:10,max:18},{id:"grade",labelEn:"Grade",labelMr:"इयत्ता",type:"text",readonly:!0},{id:"board",labelEn:"Board",labelMr:"बोर्ड",type:"select",options:[{value:"",textEn:"Select Board",textMr:"बोर्ड निवडा"},{value:"SSC",textEn:"SSC (Maharashtra State Board)",textMr:"एसएससी (महाराष्ट्र राज्य मंडळ)"},{value:"CBSE",textEn:"CBSE",textMr:"सीबीएसई"},{value:"ICSE",textEn:"ICSE",textMr:"आयसीएसई"},{value:"IB",textEn:"IB",textMr:"आयबी"},{value:"IGCSE",textEn:"IGCSE",textMr:"आयजीसीएसई"},{value:"Other",textEn:"Other",textMr:"इतर"}]},{id:"medium",labelEn:"Medium of Instruction",labelMr:"शिक्षणाचे माध्यम",type:"select",options:[{value:"",textEn:"Select Medium",textMr:"माध्यम निवडा"},{value:"English",textEn:"English",textMr:"इंग्रजी"},{value:"Marathi",textEn:"Marathi",textMr:"मराठी"},{value:"Semi-English",textEn:"Semi-English",textMr:"सेमी-इंग्रजी"},{value:"Other",textEn:"Other",textMr:"इतर"}]}];function u(e,t){console.log(`ALERT (${e}): ${t}`);let n=document.querySelector(".alert-dynamic");n&&n.remove();let i=document.createElement("div");i.className=`alert alert-${e} alert-dynamic`,i.setAttribute("role","alert");let s="fa-info-circle";"success"===e&&(s="fa-check-circle"),"error"===e&&(s="fa-times-circle"),"warning"===e&&(s="fa-exclamation-triangle"),i.innerHTML=`<i class="fas ${s}"></i> ${t}`;let r=document.querySelector(".container");r?r.insertBefore(i,r.children[1]||r.firstChild):document.body.insertBefore(i,document.body.firstChild),setTimeout(()=>{i.style.opacity="0",setTimeout(()=>i.remove(),500)},6e3)}function g(){try{let t=localStorage.getItem(e);r=t?JSON.parse(t):[],console.log("Loaded results count:",r.length)}catch(n){console.error("Error loading results from localStorage:",n),r=[],u("error","Failed to load previous results. Storage might be corrupted.")}}function m(){try{localStorage.setItem(e,JSON.stringify(r)),console.log("Results saved to localStorage:",r.length)}catch(t){console.error("Error saving results to localStorage:",t),u("error","Failed to save results. Storage might be full or restricted.")}}function f(){try{let e=localStorage.getItem(t);a=e?JSON.parse(e):[],console.log("Loaded student info count:",a.length)}catch(n){console.error("Error loading student info from localStorage:",n),a=[],u("error","Failed to load saved student information.")}}function p(){try{localStorage.setItem(t,JSON.stringify(a)),console.log("Student info saved to localStorage:",a.length)}catch(e){console.error("Error saving student info to localStorage:",e),u("error","Failed to save student information.")}}function y(){console.log("Resetting UI to login screen."),sessionStorage.removeItem("sessionToken"),sessionStorage.removeItem("userRole"),sessionStorage.removeItem("clientBranding"),["login-section","standard-selection","language-selection","info-section","instructions-section","test-section","results-section","admin-section","welcome-section"].forEach(e=>{let t=document.getElementById(e);t&&t.classList.add("hidden")});let e=document.getElementById("login-section");e&&e.classList.remove("hidden");let t=document.getElementById("username"),r=document.getElementById("password");t&&(t.value=""),r&&(r.value=""),c=0,o=0,l={},s={},n="",i=""}function h(){let e=sessionStorage.getItem("clientBranding");if(!e)return null;try{return JSON.parse(e)}catch(t){return console.error("Error parsing branding info from sessionStorage:",t),sessionStorage.removeItem("clientBranding"),null}}function v(){console.log("Attempting to update branding on visible sections...");let e=h(),t=e||{name:"Psychometrica Pro Plus",address:"N/A",phone:"N/A"};if(!t.name){console.warn("No valid branding name found (retrieved or default) to update UI.");return}console.log("Using branding for display:",t),["standard-selection","language-selection","info-section","instructions-section","test-section","results-section","admin-section"].forEach(e=>{let n=document.getElementById(e);if(n&&!n.classList.contains("hidden")){let i=n.querySelector(".branding-footer");i&&i.remove();let s=document.createElement("div");s.className="branding-footer",s.innerHTML=`
                    <p><i class="fas fa-building"></i> ${t.name}, ${t.address||"Address N/A"} | <i class="fas fa-phone"></i> ${t.phone||"Phone N/A"}</p>
                `,n.appendChild(s)}});let n=document.getElementById("results-section");if(n&&!n.classList.contains("hidden")){let i=n.querySelector(".contact-message p");i&&(i.innerHTML=`<i class="fas fa-info-circle"></i> For detailed discussion and counseling regarding the progress plan, please contact ${t.name} at <i class="fas fa-phone"></i> <strong>${t.phone||"N/A"}</strong>. Share the result with admin for further processing.`)}}function b(){console.log("showWelcomeScreen: Function called.");let e=h(),t=sessionStorage.getItem("userRole");if(!e||!e.name){console.warn("showWelcomeScreen: Skipping welcome screen: No branding name."),A(t);return}let n=document.querySelector(".container");if(!n){console.error("showWelcomeScreen: Container element not found."),A(t);return}let i=document.getElementById("welcome-section");i&&i.remove();let s=document.createElement("section");s.id="welcome-section",s.className="welcome-fade-in",s.classList.add("hidden"),s.innerHTML=`
            <h2>Welcome to ${e.name}</h2>
            <p><i class="fas fa-map-marker-alt"></i> ${e.address||"Address not available"}</p>
            <p><i class="fas fa-phone"></i> ${e.phone||"Contact not available"}</p>
        `;let r=n.querySelector("header");r?r.insertAdjacentElement("afterend",s):n.insertBefore(s,n.firstChild),setTimeout(()=>s.classList.remove("hidden"),10),console.log("showWelcomeScreen: Welcome section displayed."),setTimeout(()=>{s.classList.add("welcome-fade-out"),setTimeout(()=>{s.remove();let e=sessionStorage.getItem("userRole");A(e)},500)},2500)}function A(e){console.log(`handlePostLoginNavigation: Function called with role: "${e}"`);let t=document.getElementById("login-section");if(t&&t.classList.add("hidden"),"admin"===e)console.log("Navigating to Admin Dashboard."),j();else if("user"===e){console.log("Navigating to Standard Selection.");let n=document.getElementById("standard-selection");n?(n.classList.remove("hidden"),v()):(console.error("Standard selection section (#standard-selection) not found!"),u("error","Error navigating to the next step. UI component missing."),y())}else console.warn(`Unknown or null role ("${e}") received after login, navigating back to login.`),u("error","Login successful but user role is invalid. Please contact support."),y()}async function I(){console.log("login() function started...");let e=document.getElementById("username"),t=document.getElementById("password"),n=document.querySelector("#login-section .btn.primary");if(!e||!t){u("error","Login form elements are missing.");return}let i=e.value.trim(),s=t.value.trim();if(!i||!s){u("error","Please enter both username and password.");return}n&&(n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Logging in...',n.disabled=!0);let r={username:i,password:s};console.log("DEBUG: Payload being sent to Worker:",JSON.stringify(r));let a=new AbortController,o=setTimeout(()=>{a.abort(),console.warn("Login request timed out.")},2e4);try{let l=await fetch("https://my-auth-worker.equimedia4.workers.dev",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:a.signal});if(clearTimeout(o),console.log("Login response status:",l.status),401===l.status){let c=await l.json().catch(()=>({}));u("error",c?.error||"Invalid username or password."),t&&(t.value="")}else if(l.ok){let d=await l.json();if(console.log("Login API response parsed:",d),d&&!0===d.success&&d.role){u("success","Login Successful!"),sessionStorage.setItem("userRole",d.role),d.branding?sessionStorage.setItem("clientBranding",JSON.stringify(d.branding)):sessionStorage.removeItem("clientBranding"),sessionStorage.removeItem("sessionToken");let g=document.getElementById("login-section");g&&g.classList.add("hidden"),b()}else u("error",d?.error||"Login validation failed on server."),t&&(t.value="")}else{let m=await l.text().catch(()=>`Server error ${l.status}`);throw console.error("Server error response text:",m),Error(`Login failed. Server responded with status: ${l.status}`)}}catch(f){console.error("Login fetch/processing error:",f),clearTimeout(o),"AbortError"===f.name?u("error","Login request timed out. Please check your connection and try again."):u("error",`Login failed: ${f.message}. Please check connection or contact support.`)}finally{n&&(n.innerHTML='<i class="fas fa-sign-in-alt"></i> Login',n.disabled=!1)}}function N(){confirm("Are you sure you want to logout?")&&(console.log("Logging out user."),y(),u("success","You have been logged out."))}function S(){let e=document.getElementById("standard");if(!(n=e?.value)){u("warning","Please select a grade first.");return}console.log("Selected standard:",n);let t=document.getElementById("standard-selection"),i=document.getElementById("language-selection");t&&i?(t.classList.add("hidden"),i.classList.remove("hidden"),v()):(u("error","UI Error: Could not navigate to language selection."),console.error("Missing sections for language selection:",{standardSection:t,languageSection:i}))}function E(e){i=e,console.log("Selected language:",i),s={grade:n};let t=document.getElementById("language-selection"),r=document.getElementById("info-section");t&&r?(t.classList.add("hidden"),r.classList.remove("hidden"),x(c=0),v()):(u("error","UI Error: Could not navigate to student information."),console.error("Missing sections for info start:",{languageSection:t,infoSection:r}))}function x(e){let t=document.getElementById("info-step"),r=document.getElementById("info-back-btn"),a=document.getElementById("info-next-btn");if(!t||!r||!a){u("error","Info section UI elements are missing.");return}if(e<0||e>=d.length){console.error("Invalid info step index requested:",e);return}let o=d[e],l="marathi"===i,c=l?o.labelMr:o.labelEn,g="",m=s[o.id]||"";"select"===o.type?(g=`<select id="${o.id}" aria-label="${c}" ${o.readonly?"disabled":""}>`,g+=o.options.map(e=>`<option value="${e.value}" ${m===e.value?"selected":""}>${l?e.textMr:e.textEn}</option>`).join(""),g+="</select>"):g="grade"===o.id?`<p class="readonly-field">${n}</p><input type="hidden" id="grade" value="${n}">`:`<input
                type="${o.type}"
                id="${o.id}"
                placeholder="${c}"
                aria-label="${c}"
                value="${m}"
                ${o.readonly?"readonly":""}
                ${o.min?`min="${o.min}"`:""}
                ${o.max?`max="${o.max}"`:""}
                ${o.pattern?`pattern="${o.pattern}" title="Please enter a valid 10-digit number"`:""}
                required>`,t.innerHTML=`<div class="form-group">
                                    <label for="${o.id}">${c}:</label>
                                    ${g}
                                 </div>`,r.style.display=0===e?"none":"inline-block";let f=e===d.length-1?l?"पुष्टी करा":"Confirm & Proceed":l?"पुढे":"Next";a.innerHTML=`<i class="fas ${e===d.length-1?"fa-check":"fa-arrow-right"}"></i> ${f}`}function w(){if(c>=d.length)return;let e=d[c],t=document.getElementById(e.id),r="";if("grade"===e.id)r=n;else if(t)r=t.value.trim();else{console.error(`Input element not found for id: ${e.id} in nextInfoStep`),u("error","An error occurred finding the input field.");return}let a="marathi"===i,o=a?e.labelMr:e.labelEn;if(!r&&"grade"!==e.id){u("warning",`${a?"कृपया":"Please enter"} ${o}.`),t?.focus();return}if("email"===e.type&&r&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)){u("warning",a?"कृपया वैध ईमेल प्रविष्ट करा.":"Please enter a valid email address."),t?.focus();return}if("tel"===e.type&&r&&!/^\d{10}$/.test(r)){u("warning",a?"कृपया वैध १०-अंकी मोबाइल नंबर प्रविष्ट करा.":"Please enter a valid 10-digit mobile number."),t?.focus();return}if("number"===e.type&&"age"===e.id&&r){let l=parseInt(r,10);if(isNaN(l)||l<(e.min||10)||l>(e.max||18)){u("warning",a?`वय ${e.min||10} आणि ${e.max||18} दरम्यान असणे आवश्यक आहे.`:`Age must be between ${e.min||10} and ${e.max||18}.`),t?.focus();return}}if(s[e.id]=r,console.log("Updated studentData:",s),++c<d.length)x(c);else{let g=document.getElementById("info-section"),m=document.getElementById("instructions-section");if(g&&m){g.classList.add("hidden"),m.classList.remove("hidden");let f=document.getElementById("instructions-content");f&&(f.innerHTML="marathi"===i?`<h4>मार्गदर्शन सूचना</h4><p>प्रिय विद्यार्थी,</p><p>ही चाचणी तुम्हाला तुमच्या आवडी आणि क्षमता समजून घेण्यास मदत करेल. कृपया खालील सूचना काळजीपूर्वक वाचा:</p><ul><li><i class="fas fa-check-circle"></i> सर्व प्रश्नांची उत्तरे प्रामाणिकपणे द्या. काही प्रश्नांसाठी कोणतेही बरोबर किंवा चूक उत्तर नाही.</li><li><i class="fas fa-check-circle"></i> प्रत्येक प्रश्नासाठी तुम्हाला सर्वात योग्य वाटणारा पर्याय निवडा.</li><li><i class="fas fa-check-circle"></i> कोणतीही वेळ मर्यादा नाही, त्यामुळे विचारपूर्वक उत्तरे द्या.</li><li><i class="fas fa-check-circle"></i> चाचणी पूर्ण झाल्यावर तुम्हाला तुमचा निकाल आणि मार्गदर्शन मिळेल.</li></ul><p>तुम्हाला परीक्षेसाठी शुभेच्छा!</p>`:'<h4>Instructions</h4><p>Dear Student,</p><p>This test will help you understand your interests and abilities. Please read the instructions carefully:</p><ul><li><i class="fas fa-check-circle"></i> Answer all questions honestly. For some sections, there are no right or wrong answers.</li><li><i class="fas fa-check-circle"></i> Choose the option that best describes you for each question.</li><li><i class="fas fa-check-circle"></i> There is no time limit, so take your time to think.</li><li><i class="fas fa-check-circle"></i> You will receive your results and recommendations upon completion.</li></ul><p>Best of luck!</p>'),v()}else u("error","UI Error: Could not navigate to instructions."),console.error("Missing sections for instruction navigation:",{infoSection:g,instructionsSection:m})}}function P(){c>0&&x(--c)}function _(e){let t=document.getElementById(e);if(!t){console.error(`goBack: Current section with ID "${e}" not found.`);return}let n;switch(e){case"language-selection":n="standard-selection";break;case"info-section":n="language-selection";break;case"instructions-section":n="info-section",x(c=d.length-1);break;case"test-section":if(!confirm("marathi"===i?"तुम्ही चाचणीमधून बाहेर पडून सूचनांवर परत जाऊ इच्छिता? तुमची प्रगती जतन केली जाणार नाही.":"Are you sure you want to exit the test and go back to instructions? Your progress will not be saved."))return;n="instructions-section",o=0,l={};break;default:console.warn("goBack called from an unhandled section:",e);return}let s=document.getElementById(n);s?(t.classList.add("hidden"),s.classList.remove("hidden"),v()):(u("error","Navigation Error: Could not find the previous section to go back to."),console.error("Error finding previous section for goBack:",{currentSectionId:e,prevSectionId:n}))}function C(){let e=document.getElementById("instructions-section"),t=document.getElementById("test-section");e&&t?(e.classList.add("hidden"),t.classList.remove("hidden"),l={},$(o=0),v()):(u("error","UI Error: Could not navigate to the test section."),console.error("Missing sections for test start:",{instructionsSection:e,testSection:t}))}function $(e){let t=n>=5&&n<=8?window.questions5to8:n>=9&&n<=10?window.questions9to10:null;if(!t||!t[i]){u("error","Questions data could not be loaded. Please check configuration."),console.error("Questions set not found for:",{selectedStandard:n,selectedLanguage:i});return}let s=t[i];if(e<0||e>=s.length){console.error("Invalid question index:",e);return}let r=s[e],a=document.getElementById("questions");if(!r||!a){u("error","Error loading question data or UI element."),console.error("Error loading question content:",{index:e,question:r,questionsDiv:a});return}let o=r.options.map((t,n)=>`
            <label class="option-label">
                <input type="radio" name="q${e}" value="${t}" ${l[e]===t?"checked":""}>
                <span>${t}</span>
            </label>
        `).join(""),c=r.text;c=`${e+1}. ${c=c.replace(/^\d+\.\s*/,"")}`,a.innerHTML=`
            <div class="question" data-question-index="${e}">
                <p class="question-text">${c}</p>
                <div class="options">${o}</div>
            </div>`,L(e,s.length)}function L(e,t){let n=document.getElementById("progress-fill"),i=document.getElementById("progress-text"),s=document.getElementById("back-btn"),r=document.getElementById("next-btn"),a=document.getElementById("submit-btn");n&&i&&s&&r&&a?(n.style.width=`${t>0?(e+1)/t*100:0}%`,i.textContent=`Question ${e+1} of ${t}`,s.style.display=0===e?"none":"inline-block",r.style.display=e===t-1?"none":"inline-block",a.style.display=e===t-1?"inline-block":"none"):console.error("UI Error: Progress bar or test navigation buttons not found.")}function B(){let e=n>=5&&n<=8?window.questions5to8:n>=9&&n<=10?window.questions9to10:null;if(!e||!e[i])return;let t=e[i],s=document.querySelector(`input[name="q${o}"]:checked`);if(!s){u("warning","marathi"===i?"पुढे जाण्यापूर्वी कृपया एक पर्याय निवडा.":"Please select an option before proceeding.");return}l[o]=s.value,o<t.length-1?$(++o):console.log("Reached the end of questions. Submit button should be used.")}function R(){let e=document.querySelector(`input[name="q${o}"]:checked`);e&&(l[o]=e.value),o>0&&$(--o)}async function k(){let e=n>=5&&n<=8?window.questions5to8:n>=9&&n<=10?window.questions9to10:null;if(!e||!e[i]){u("error","Questions data not found. Cannot submit.");return}let t=e[i],a=document.querySelector(`input[name="q${o}"]:checked`);if(o===t.length-1&&!a){u("warning","marathi"===i?"सबमिट करण्यापूर्वी कृपया शेवटच्या प्रश्नासाठी एक पर्याय निवडा.":"Please select an option for the last question before submitting.");return}a&&(l[o]=a.value);let c=document.getElementById("submit-btn");c&&(c.innerHTML='<i class="fas fa-spinner fa-spin"></i> Submitting...',c.disabled=!0);try{if(await new Promise(e=>setTimeout(e,150)),"function"!=typeof window.calculateResults)throw console.error("calculateResults function is not defined on window object."),Error("Calculation function is missing or not loaded correctly.");let d=window.calculateResults(parseInt(n),i,l);if(console.log("Calculated result object:",d),!d||!d.detailedResult||!d.detailedResult.scores)throw console.error("Invalid result structure returned from calculateResults:",d),Error("Calculation function returned an invalid result structure.");let g={studentData:s||{},result:d.detailedResult,date:d.date,summary:d.summary};r.push(g),m(),console.log("Result saved locally.");let f=document.getElementById("test-section"),p=document.getElementById("results-section"),y=document.getElementById("result-content"),h=document.getElementById("trophy-sign");if(f&&p&&y&&h){f.classList.add("hidden"),p.classList.remove("hidden");let b=d.detailedResult.scores?.percentage??0,A=n<=8&&b>80,I=d.detailedResult.scores,N=[I?.realistic,I?.investigative,I?.artistic,I?.social,I?.enterprising,I?.conventional].map(e=>e??0),S=n>8&&Math.max(...N)>30;h.style.display=A||S?"block":"none";let E="";if(n<=8&&d.detailedResult.personalityProfile){let x=d.detailedResult.personalityProfile,w=i,P=(e,t,n)=>{let i=x[e];if(!i)return"";let s="fa-question-circle";return"sociability"===e&&(s="fa-users"),"openness"===e&&(s="fa-lightbulb"),"agreeableness"===e&&(s="fa-handshake"),"persistence"===e&&(s="fa-forward"),"anxiety"===e&&(s="fa-heartbeat"),"artistic"===e&&(s="fa-paint-brush"),"investigative"===e&&(s="fa-search"),`<p><strong><i class="fas ${s}"></i> ${"marathi"===w?n:t}:</strong> ${i}</p>`};E=`
                        <div class="result-details personality-section">
                            <h4>Basic Personality Insights</h4>
                            ${P("sociability","Sociability","सामाजिकता")}
                            ${P("openness","Openness/Curiosity","मोकळेपणा/जिज्ञासा")}
                            ${P("agreeableness","Agreeableness","सहमतता")}
                            ${P("persistence","Persistence","चिकाटी")}
                            ${P("anxiety","Anxiety Level","चिंता पातळी")}
                            ${P("artistic","Artistic Interest","कलात्मक आवड")}
                            ${P("investigative","Investigative Interest","शोधक आवड")}
                        </div>`}let _="";if(d.detailedResult.scores){if(n<=8)_=`
                            <p><strong><i class="fas fa-bullseye"></i> Aptitude Score:</strong> ${d.detailedResult.scores.percentage?.toFixed(1)??"N/A"}%</p>
                            <p class="score-breakdown"><em>(Scored ${d.detailedResult.scores.score??"N/A"} / ${d.detailedResult.scores.scoredQuestions??"N/A"} Aptitude Questions)</em></p>
                        `;else{let C=d.detailedResult.scores;_=`
                            <div class="riasec-scores">
                                <p><strong>Realistic:</strong> ${C.realistic??"N/A"}</p>
                                <p><strong>Investigative:</strong> ${C.investigative??"N/A"}</p>
                                <p><strong>Artistic:</strong> ${C.artistic??"N/A"}</p>
                                <p><strong>Social:</strong> ${C.social??"N/A"}</p>
                                <p><strong>Enterprising:</strong> ${C.enterprising??"N/A"}</p>
                                <p><strong>Conventional:</strong> ${C.conventional??"N/A"}</p>
                            </div>`}}y.innerHTML=`
                    <div class="result-details main-results">
                        <p><strong><i class="fas fa-user"></i> Student Name:</strong> ${s["student-name"]||"N/A"}</p>
                        <p><strong><i class="fas fa-graduation-cap"></i> Grade:</strong> ${s.grade||"N/A"}</p>
                        <p><strong><i class="fas fa-calendar-alt"></i> Date:</strong> ${d.date||"N/A"}</p>
                        <p style="grid-column: 1 / -1;"><strong><i class="fas fa-clipboard-list"></i> Summary:</strong> ${d.summary||"N/A"}</p>
                         ${_}
                        <p style="grid-column: 1 / -1;"><strong><i class="fas fa-chart-bar"></i> Analysis:</strong> ${d.detailedResult.analysis||"N/A"}</p>
                    </div>

                    ${E}

                    <div class="recommendations-container">
                        <div class="recommendations-toggle"><i class="fas fa-chevron-down"></i> Show Recommendations <i class="fas fa-chevron-down"></i></div>
                        <ul class="recommendations-list">
                            ${(d.detailedResult.recommendations||[]).map(e=>`<li><i class="fas fa-star"></i> ${e}</li>`).join("")}
                        </ul>
                    </div>`;let $=y.querySelector(".recommendations-toggle");$?$.addEventListener("click",()=>T($)):console.warn("Recommendations toggle button not found after rendering results."),v()}else console.error("Error displaying results - one or more container elements not found:",{testSection:f,resultsSection:p,resultContent:y,trophySign:h}),u("error","Error displaying results area. UI components missing.")}catch(L){console.error("Error during submitTest process:",L),u("error",`Error calculating or displaying results. Details: ${L.message}`)}finally{c&&(c.innerHTML='<i class="fas fa-check"></i> Submit',c.disabled=!1)}}function T(e){let t=e.nextElementSibling;if(t&&t.classList.contains("recommendations-list")){let n=!t.classList.contains("active");t.classList.toggle("active"),e.innerHTML=n?'<i class="fas fa-chevron-up"></i> Hide Recommendations <i class="fas fa-chevron-up"></i>':'<i class="fas fa-chevron-down"></i> Show Recommendations <i class="fas fa-chevron-down"></i>'}else console.warn("Could not find recommendations list element immediately after the toggle button.")}function M(e=!1){let t=null,n=null;if(e){if(0===r.length)return u("warning","No results available in local storage to share."),null;n=(t=r[r.length-1]).studentData||{}}else{if(!s||0===Object.keys(s).length)return u("warning","Current student data is missing."),null;if(0===r.length)return u("warning","No result found for the current session."),null;t=r[r.length-1],n=s}if(!t||!t.result)return u("error","Selected result data is incomplete or invalid."),console.error("Incomplete result data for sharing:",t),null;let i=t.result,a=(i.recommendations||[]).map((e,t)=>`${t+1}. ${e}`).join("\n"),o=h()||{name:"Psychometrica Pro Plus",phone:"N/A"},l=`*Psychometrica Pro Plus Results*
------------------------------------
`;return l+=`*Student:* ${n["student-name"]||"N/A"}
`,l+=`*Grade:* ${n.grade||"N/A"}
`,l+=`*Date:* ${t.date||"N/A"}

`,l+=`*Summary:* ${t.summary||"N/A"}
`,l+=`*Analysis:* ${i.analysis||"N/A"}

`,i.scores&&(l+=`*Score Details:*
`,8>=parseInt(n.grade)?(l+=` - Aptitude Score: ${i.scores.percentage?.toFixed(1)??"N/A"}%
`,l+=` - (Scored ${i.scores.score??"N/A"} / ${i.scores.scoredQuestions??"N/A"} Aptitude Questions)
`):(l+=` - Realistic: ${i.scores.realistic??"N/A"}
`,l+=` - Investigative: ${i.scores.investigative??"N/A"}
`,l+=` - Artistic: ${i.scores.artistic??"N/A"}
`,l+=` - Social: ${i.scores.social??"N/A"}
`,l+=` - Enterprising: ${i.scores.enterprising??"N/A"}
`,l+=` - Conventional: ${i.scores.conventional??"N/A"}
`),l+=`
`),i.personalityProfile&&8>=parseInt(n.grade)&&(l+=`*Basic Personality Insights:*
`,l+=` - Sociability: ${i.personalityProfile.sociability||"N/A"}
`,l+=` - Openness/Curiosity: ${i.personalityProfile.openness||"N/A"}
`,l+=` - Agreeableness: ${i.personalityProfile.agreeableness||"N/A"}
`,l+=` - Persistence: ${i.personalityProfile.persistence||"N/A"}
`,l+=` - Anxiety Level: ${i.personalityProfile.anxiety||"N/A"}
`,l+=` - Artistic Interest: ${i.personalityProfile.artistic||"N/A"}
`,l+=` - Investigative Interest: ${i.personalityProfile.investigative||"N/A"}
`,l+=`
`),a&&(l+=`*Recommendations:*
${a}

`),l+=`------------------------------------
`,(l+=`Shared via ${o.name} (${o.phone})`).trim()}function F(e=!1){let t=M(e);if(!t)return;let n=`https://wa.me/?text=${encodeURIComponent(t)}`;window.open(n,"_blank"),e&&u("info","Please select the recipient in WhatsApp.")}function q(){let e=M(!1);e&&navigator.clipboard.writeText(e).then(()=>{u("success","Results copied to clipboard.")}).catch(e=>{console.error("Failed to copy results to clipboard:",e),u("error","Could not copy results. Your browser might block this action.")})}function D(e=!1){console.log(`emailResult (Copy Mode) called. isAdminContext: ${e}`);let t=M(e);if(!t){console.error("formatResultText returned null, cannot proceed with email copy.");return}let n="Student";e&&r.length>0?n=r[r.length-1]?.studentData?.["student-name"]||"Student":!e&&s&&(n=s["student-name"]||"Student"),navigator.clipboard.writeText(t).then(()=>{console.log("Result text copied to clipboard successfully."),u("success",`Results for ${n} copied! Please open your email client (Gmail, Outlook, etc.) and paste this into a new email.`)}).catch(e=>{console.error("Failed to copy result text to clipboard:",e),u("error","Could not copy results to clipboard. Please try copying manually.")})}function O(){if("function"!=typeof window.jspdf?.jsPDF){u("error","Certificate generation library (jsPDF) is not loaded."),console.error("jsPDF library not found on window.jspdf");return}let{jsPDF:e}=window.jspdf;if(!s||0===Object.keys(s).length||0===r.length){u("warning","Cannot generate certificate. Student data or result is missing for the current session.");return}let t=r[r.length-1],n=s;if(!t||!t.result||!n){u("error","Incomplete data for certificate generation."),console.error("Missing data for certificate:",{lastResult:t,currentStudentInfo:n});return}try{let i=new e({orientation:"landscape",unit:"mm",format:"a4"}),a=h()||{name:"Psychometrica Pro Plus",address:"N/A",phone:"N/A"},o=n["student-name"]||"Student",l=n.grade||"N/A",c=t.date||new Date().toLocaleDateString("en-GB").replace(/\//g,"-"),d=t.summary||"Assessment Completed",g="Helvetica",m="#1B3B6F",f="#F4A261",p="#1F2A44",y="#6B7280";i.setLineWidth(1.5),i.setDrawColor(m),i.rect(10,10,277,190),i.setLineWidth(.5),i.setDrawColor(f),i.rect(15,15,267,180),i.setFont(g,"bold"),i.setFontSize(26),i.setTextColor(m),i.text(a.name.toUpperCase(),148.5,35,{align:"center"}),i.setFont(g,"normal"),i.setFontSize(16),i.setTextColor("#2A9D8F"),i.text("Certificate of Completion",148.5,45,{align:"center"}),i.setFontSize(14),i.setTextColor(y),i.text("This certificate is proudly presented to",148.5,70,{align:"center"}),i.setFontSize(28),i.setFont(g,"bold"),i.setTextColor(p),i.text(o.toUpperCase(),148.5,85,{align:"center"}),i.setFont(g,"normal"),i.setFontSize(14),i.setTextColor(y),i.text("For successfully completing the Psychometric Assessment",148.5,100,{align:"center"}),i.setFontSize(12),i.setTextColor(p),i.text(`Grade: ${l}`,148.5,115,{align:"center"}),i.text(`Date: ${c}`,148.5,125,{align:"center"}),d.length<80&&i.text(`Result Summary: ${d}`,148.5,135,{align:"center"}),i.setLineWidth(.3),i.setDrawColor(f),i.line(40,155,257,155),i.setFontSize(12),i.setFont(g,"bold"),i.setTextColor(m),i.text(`Issued by: ${a.name}`,148.5,165,{align:"center"}),i.setFont(g,"normal"),i.setFontSize(10),i.setTextColor(y),i.text(`Contact: ${a.phone||"N/A"} | Address: ${a.address||"N/A"}`,148.5,172,{align:"center"}),i.text("Powered by Psychometrica Pro Plus",148.5,180,{align:"center"});let v=o.replace(/[^a-z0-9]/gi,"_").substring(0,30);i.save(`Psychometrica_Certificate_${v}.pdf`),u("success","Certificate downloaded successfully.")}catch(b){console.error("Error generating PDF certificate:",b),u("error",`Failed to generate certificate: ${b.message}`)}}function j(){console.log("Showing admin dashboard.");let e=document.getElementById("admin-section"),t=document.querySelector("#results-table tbody"),n=document.querySelector("#student-info-table tbody");if(!e||!t||!n){u("error","Admin dashboard UI components are missing. Cannot display."),y();return}g(),f(),e.classList.remove("hidden");let i=e.querySelectorAll(".critical-warning");i.forEach(e=>e.style.display="block"),0===r.length?t.innerHTML='<tr><td colspan="4" style="text-align:center; padding: 20px;">No test results have been saved yet.</td></tr>':t.innerHTML=r.map(e=>`
                <tr>
                    <td>${e.studentData?.["student-name"]||"N/A"}</td>
                    <td>${e.studentData?.grade||"N/A"}</td>
                    <td>${e.date||"N/A"}</td>
                    <td>${e.summary||"N/A"}</td>
                </tr>`).join(""),0===a.length?n.innerHTML='<tr><td colspan="9" style="text-align:center; padding: 20px;">No student information has been saved yet.</td></tr>':n.innerHTML=a.map(e=>`
                <tr>
                    <td>${e.studentName||"N/A"}</td>
                    <td>${e.parentName||"N/A"}</td>
                    <td>${e.mobile||"N/A"}</td>
                    <td>${e.email||"N/A"}</td>
                    <td>${e.school||"N/A"}</td>
                    <td>${e.age||"N/A"}</td>
                    <td>${e.board||"N/A"}</td>
                    <td>${e.standard||"N/A"}</td>
                    <td>${e.medium||"N/A"}</td>
                </tr>`).join(""),v()}function U(){confirm("DANGER: Are you sure you want to permanently clear ALL locally stored test reports? This action cannot be undone. Export data first!")&&confirm("FINAL CONFIRMATION: Delete all test reports?")&&(r=[],m(),j(),u("success","All local test reports have been cleared."))}function H(){if(!r.length){u("warning","No test results available to export.");return}let e=["Student Name","Grade","Date","Summary","Analysis","Realistic","Investigative","Artistic","Social","Enterprising","Conventional","Aptitude Score","Aptitude Scored Questions","Aptitude Percentage","Sociability","Openness/Curiosity","Agreeableness","Persistence","Anxiety Level","Artistic Interest","Investigative Interest","Recommendations","Total Items in Test"],t=e.join(",")+"\n";r.forEach(n=>{let i=n.studentData?.["student-name"]||"",s=n.studentData?.grade||"",r=n.date||"",a=n.summary||"",o=n.result?.analysis||"",l=(n.result?.recommendations||[]).map(e=>`- ${e}`).join(" | "),c={"Student Name":i,Grade:s,Date:r,Summary:a,Analysis:o,Recommendations:l,Realistic:"N/A",Investigative:"N/A",Artistic:"N/A",Social:"N/A",Enterprising:"N/A",Conventional:"N/A","Aptitude Score":"N/A","Aptitude Scored Questions":"N/A","Aptitude Percentage":"N/A",Sociability:"N/A","Openness/Curiosity":"N/A",Agreeableness:"N/A",Persistence:"N/A","Anxiety Level":"N/A","Artistic Interest":"N/A","Investigative Interest":"N/A","Total Items in Test":"N/A"};n.result?.scores&&(c["Total Items in Test"]=n.result.scores.totalItems??"N/A",parseInt(s)>8?Object.assign(c,{Realistic:n.result.scores.realistic??"N/A",Investigative:n.result.scores.investigative??"N/A",Artistic:n.result.scores.artistic??"N/A",Social:n.result.scores.social??"N/A",Enterprising:n.result.scores.enterprising??"N/A",Conventional:n.result.scores.conventional??"N/A"}):Object.assign(c,{"Aptitude Score":n.result.scores.score??"N/A","Aptitude Scored Questions":n.result.scores.scoredQuestions??"N/A","Aptitude Percentage":n.result.scores.percentage?.toFixed(1)??"N/A"})),n.result?.personalityProfile&&8>=parseInt(s)&&Object.assign(c,{Sociability:n.result.personalityProfile.sociability||"N/A","Openness/Curiosity":n.result.personalityProfile.openness||"N/A",Agreeableness:n.result.personalityProfile.agreeableness||"N/A",Persistence:n.result.personalityProfile.persistence||"N/A","Anxiety Level":n.result.personalityProfile.anxiety||"N/A","Artistic Interest":n.result.personalityProfile.artistic||"N/A","Investigative Interest":n.result.personalityProfile.investigative||"N/A"});let d=e=>{let t=String(e??"");return t.includes(",")||t.includes("\n")||t.includes('"')?`"${t.replace(/"/g,'""')}"`:t},u=e.map(e=>d(c[e])).join(",");t+=u+"\n"});let n=new Blob([t],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.href=URL.createObjectURL(n);let s=new Date().toISOString().replace(/[:.]/g,"-");i.download=`Psychometrica_All_Results_${s}.csv`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(i.href),u("success","All results exported to CSV successfully.")}function G(){let e={studentName:document.getElementById("info-student-name"),parentName:document.getElementById("info-parent-name"),mobile:document.getElementById("info-mobile"),email:document.getElementById("info-email"),school:document.getElementById("info-school"),age:document.getElementById("info-age"),board:document.getElementById("info-board"),standard:document.getElementById("info-standard"),medium:document.getElementById("info-medium")};if(Object.values(e).some(e=>!e)){u("error","Student information form fields are missing. Cannot submit.");return}let t={studentName:e.studentName.value.trim(),parentName:e.parentName.value.trim(),mobile:e.mobile.value.trim(),email:e.email.value.trim(),school:e.school.value.trim(),age:e.age.value,board:e.board.value,standard:e.standard.value,medium:e.medium.value};if(!t.studentName||!t.parentName||!t.mobile||!t.email||!t.school||!t.age||!t.board||!t.standard||!t.medium){u("warning","Please fill in all student information fields.");return}let n=parseInt(t.age,10);if(isNaN(n)||n<10||n>18){u("warning","Valid age (10-18) is required."),e.age.focus();return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email)){u("warning","Please enter a valid email address."),e.email.focus();return}if(!/^\d{10}$/.test(t.mobile)){u("warning","Please enter a valid 10-digit mobile number."),e.mobile.focus();return}t.age=n,t.timestamp=new Date().toISOString(),a.push(t),p(),j(),Object.values(e).forEach(e=>e.value=""),u("success","Student information saved successfully.")}function Q(){if(!a.length){u("warning","No student information available to export.");return}let e=["studentName","parentName","mobile","email","school","age","board","standard","medium","timestamp"],t="Student Name,Parent Name,Mobile,Email,School,Age,Board,Standard,Medium,Timestamp\n",n=e=>{let t=String(e??"");return t.includes(",")||t.includes("\n")||t.includes('"')?`"${t.replace(/"/g,'""')}"`:t};a.forEach(i=>{let s=e.map(e=>n(i[e])).join(",");t+=s+"\n"});let i=new Blob([t],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(i);let r=new Date().toISOString().replace(/[:.]/g,"-");s.download=`Student_Information_${r}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(s.href),u("success","Student information exported to CSV successfully.")}function W(){confirm("DANGER: Are you sure you want to permanently clear ALL locally stored student information? This action cannot be undone. Export data first!")&&confirm("FINAL CONFIRMATION: Delete all student information?")&&(a=[],p(),j(),u("success","All local student information has been cleared."))}function z(){let e=document.getElementById("plan-text")?.textContent;if(!e||""===e.trim()){u("warning","No development plan has been generated yet to share.");return}let t=h()||{name:"Psychometrica Pro Plus"},n=`*Development Plan from ${t.name}*

${e}`,i=`https://wa.me/?text=${encodeURIComponent(n)}`;window.open(i,"_blank"),u("info","Please select the recipient in WhatsApp.")}function V(){console.log("emailPlan (Copy Mode) called.");let e=document.getElementById("plan-text")?.textContent;if(!e||""===e.trim()){u("warning","No development plan has been generated yet to email.");return}let t=document.getElementById("plan-student-name")?.value?.trim()||"Student";navigator.clipboard.writeText(e).then(()=>{console.log("Plan text copied to clipboard successfully."),u("success",`Plan for ${t} copied! Please open your email client (Gmail, Outlook, etc.) and paste this into a new email.`)}).catch(e=>{console.error("Failed to copy plan text to clipboard:",e),u("error","Could not copy the plan to the clipboard. Please try copying manually.")})}console.log("SCRIPT INFO: Assigning functions to window object for HTML access..."),window.login=I,window.confirmLogout=N,window.showLanguageSelection=S,window.startTest=E,window.nextInfoStep=w,window.previousInfoStep=P,window.showTest=C,window.nextQuestion=B,window.previousQuestion=R,window.submitTest=k,window.shareOnWhatsApp=F,window.copyResultCode=q,window.emailResult=D,window.goBack=_,window.exportAllToExcel=H,window.toggleRecommendations=T,window.downloadCertificate=O,window.clearReports=U,window.sharePlanOnWhatsApp=z,window.emailPlan=V,window.submitStudentInfo=G,window.exportStudentInfoToCSV=Q,window.clearStudentInfo=W,window.getClientBranding=h,console.log("SCRIPT INFO: Initializing application state..."),g(),f(),y(),console.log("SCRIPT END: Initialization complete. Application ready.")});
